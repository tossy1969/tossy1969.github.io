<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中野新橋駅 フラップサイネージ</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #1a1a1a;
            font-family: 'Courier New', Courier, monospace;
        }
        .signage {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border-top: 5px solid #ff0000;
            width: 600px;
            transform: scale(1.1);
            transform-origin: top center;
        }
        .signage[lang="ja"] {
            font-family: 'Yu Gothic', 'MS Gothic', sans-serif;
        }
        .signage[lang="en"] {
            font-family: 'Helvetica', 'Arial', sans-serif;
        }
        .title {
            font-size: 22px;
            font-weight: bold;
            color: #fff;
            text-align: center;
            margin-bottom: 10px;
            height: 30px;
            line-height: 30px;
        }
        .table {
            display: grid;
            gap: 5px;
        }
        .row {
            display: grid;
            grid-template-columns: 50px 120px 150px 1fr;
            gap: 5px;
            min-height: 40px;
        }
        .header {
            color: #fff;
            font-size: 14px;
            text-align: center;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .flap {
            height: 40px;
            background-color: #000;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            position: relative;
            overflow: hidden;
            border: 1px solid #444;
            text-align: center;
        }
        .flap[id^="time-"] {
            font-size: 22px;
            font-family: 'Helvetica', 'Arial', sans-serif;
        }
        .flap[id^="destination-"] {
            font-size: 20px;
        }
        .flap.status {
            width: 50px;
            font-size: 24px;
        }
        .flap span {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
            text-align: center;
        }
        .flap span.next {
            transform: translateY(-100%);
        }
        .flap span.current {
            transform: translateY(0);
        }
        .flap span.prev {
            transform: translateY(100%);
        }
        .status.grey span {
            color: #999;
        }
        .status.orange span {
            color: #ff6200;
        }
        .status.blink span {
            animation: blink 1.5s ease-in-out infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="signage" lang="ja">
        <div class="title" id="title"><span class="current">Ⓜ MB05 丸ノ内線・中野新橋駅出発</span></div>
        <div class="table">
            <div class="row">
                <div class="header"></div>
                <div class="header">Departure</div>
                <div class="header">Destination</div>
                <div class="header">Remarks</div>
            </div>
            <div class="row" id="row-0">
                <div class="flap status" id="status-0"><span class="current">●</span></div>
                <div class="flap" id="time-0"><span class="current">-</span></div>
                <div class="flap" id="destination-0"><span class="current">-</span></div>
                <div class="flap" id="remarks-0"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-1">
                <div class="flap status" id="status-1"><span class="current">●</span></div>
                <div class="flap" id="time-1"><span class="current">-</span></div>
                <div class="flap" id="destination-1"><span class="current">-</span></div>
                <div class="flap" id="remarks-1"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-2">
                <div class="flap status" id="status-2"><span class="current">●</span></div>
                <div class="flap" id="time-2"><span class="current">-</span></div>
                <div class="flap" id="destination-2"><span class="current">-</span></div>
                <div class="flap" id="remarks-2"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-3">
                <div class="flap status" id="status-3"><span class="current">●</span></div>
                <div class="flap" id="time-3"><span class="current">-</span></div>
                <div class="flap" id="destination-3"><span class="current">-</span></div>
                <div class="flap" id="remarks-3"><span class="current">-</span></div>
            </div>
        </div>
    </div>

    <script>
        // 時刻表データ（東京メトロ公式より正確に抽出）
        const timetable = {
            weekday: {
                honancho: [
                    "05:12", "05:28", "05:40", "05:50", "06:00", "06:08", "06:15", "06:22", "06:28", "06:34",
                    "06:40", "06:46", "06:52", "06:58", "07:04", "07:10", "07:16", "07:22", "07:28", "07:34",
                    "07:40", "07:46", "07:52", "07:58", "08:04", "08:10", "08:16", "08:22", "08:28", "08:34",
                    "08:40", "08:46", "08:52", "08:58", "09:04", "09:10", "09:16", "09:22", "09:30", "09:38",
                    "09:46", "09:54", "10:02", "10:10", "10:18", "10:26", "10:34", "10:42", "10:50", "10:58",
                    "11:06", "11:14", "11:22", "11:30", "11:38", "11:46", "11:54", "12:02", "12:10", "12:18",
                    "12:26", "12:34", "12:42", "12:50", "12:58", "13:06", "13:14", "13:22", "13:30", "13:38",
                    "13:46", "13:54", "14:02", "14:10", "14:18", "14:26", "14:34", "14:42", "14:50", "14:58",
                    "15:06", "15:14", "15:22", "15:30", "15:38", "15:46", "15:54", "16:02", "16:10", "16:18",
                    "16:26", "16:34", "16:42", "16:50", "16:58", "17:02", "17:09", "17:16", "17:24", "17:32",
                    "17:40", "17:48", "17:56", "18:02", "18:10", "18:18", "18:26", "18:34", "18:42", "18:50",
                    "18:58", "19:06", "19:14", "19:22", "19:30", "19:38", "19:46", "19:54", "20:02", "20:10",
                    "20:18", "20:26", "20:34", "20:42", "20:50", "20:58", "21:06", "21:14", "21:22", "21:30",
                    "21:38", "21:46", "21:54", "22:02", "22:10", "22:18", "22:26", "22:34", "22:42", "22:50",
                    "22:58", "23:06", "23:14", "23:22", "23:30", "23:38", "23:46", "23:54", "00:02", "00:10", "00:21"
                ],
                nakanoSakaue: [
                    "05:17", "05:33", "05:45", "05:55", "06:05", "06:13", "06:20", "06:27", "06:33", "06:39",
                    "06:45", "06:51", "06:57", "07:03", "07:15", "07:27", "07:39", "07:51", "08:03", "08:15",
                    "08:27", "08:39", "08:51", "09:03", "09:15", "09:27", "09:35", "09:43", "09:51", "09:59",
                    "10:07", "10:15", "10:23", "10:31", "10:39", "10:47", "10:55", "11:03", "11:11", "11:19",
                    "11:27", "11:35", "11:43", "11:51", "11:59", "12:07", "12:15", "12:23", "12:31", "12:39",
                    "12:47", "12:55", "13:03", "13:11", "13:19", "13:27", "13:35", "13:43", "13:51", "13:59",
                    "14:07", "14:15", "14:23", "14:31", "14:39", "14:47", "14:55", "15:03", "15:11", "15:19",
                    "15:27", "15:35", "15:43", "15:51", "15:59", "16:07", "16:15", "16:23", "16:31", "16:39",
                    "16:47", "16:55", "17:03", "17:11", "17:19", "17:27", "17:35", "17:43", "17:51", "17:59",
                    "18:07", "18:15", "18:23", "18:31", "18:39", "18:47", "18:55", "19:03", "19:11", "19:19",
                    "19:27", "19:35", "19:43", "19:51", "19:59", "20:07", "20:15", "20:23", "20:31", "20:39",
                    "20:47", "20:55", "21:03", "21:11", "21:19", "21:27", "21:35", "21:43", "21:51", "21:59",
                    "22:07", "22:15", "22:23", "22:31", "22:39", "22:47", "22:55", "23:03", "23:11", "23:19",
                    "23:27", "23:35", "23:43", "23:51", "23:59", "00:07", "00:15", "00:31"
                ],
                nakanoFujimicho: [
                    "07:13", "07:37", "08:01", "08:25", "08:49", "09:25", "10:01", "10:37", "11:13", "11:49",
                    "12:25", "13:01", "13:37", "14:13", "14:49", "15:25", "16:01", "16:37", "17:13", "17:49",
                    "18:25", "19:01", "19:37", "20:13", "20:49", "21:25", "22:01", "22:37", "23:13"
                ],
                myogadani: [
                    "07:09", "07:33", "08:05", "08:29", "09:07", "09:43", "10:19", "10:55", "11:31", "12:07",
                    "12:43", "13:19", "13:55", "14:31", "15:07", "15:43", "16:19", "16:55", "17:31", "18:07",
                    "18:43", "19:19", "19:55", "20:31", "21:07", "21:43", "22:19", "22:55"
                ],
                ikebukuro: [
                    "07:21", "07:45", "08:09", "08:37", "09:13", "09:49", "10:25", "11:01", "11:37", "12:13",
                    "12:49", "13:25", "14:01", "14:37", "15:13", "15:49", "16:25", "17:01", "17:37", "18:13",
                    "18:49", "19:25", "20:01", "20:37", "21:13", "21:49", "22:25", "23:01"
                ]
            },
            holiday: {
                honancho: [
                    "05:12", "05:28", "05:40", "05:52", "06:04", "06:16", "06:28", "06:40", "06:52", "07:04",
                    "07:16", "07:28", "07:40", "07:52", "08:04", "08:14", "08:24", "08:34", "08:44", "08:54",
                    "09:04", "09:14", "09:24", "09:34", "09:44", "09:54", "10:04", "10:14", "10:24", "10:34",
                    "10:44", "10:54", "11:04", "11:14", "11:24", "11:34", "11:44", "11:54", "12:04", "12:14",
                    "12:24", "12:34", "12:44", "12:54", "13:04", "13:14", "13:24", "13:34", "13:44", "13:54",
                    "14:04", "14:14", "14:24", "14:34", "14:44", "14:54", "15:04", "15:14", "15:24", "15:34",
                    "15:44", "15:54", "16:04", "16:14", "16:24", "16:34", "16:44", "16:54", "17:04", "17:14",
                    "17:24", "17:34", "17:44", "17:54", "18:04", "18:14", "18:24", "18:34", "18:44", "18:54",
                    "19:04", "19:14", "19:24", "19:34", "19:44", "19:54", "20:04", "20:14", "20:24", "20:34",
                    "20:44", "20:54", "21:04", "21:14", "21:24", "21:34", "21:44", "21:54", "22:04", "22:14",
                    "22:24", "22:34", "22:44", "22:54", "23:04", "23:14", "23:24", "23:34", "23:44", "23:54",
                    "00:04", "00:14", "00:21"
                ],
                nakanoSakaue: [
                    "05:17", "05:33", "05:45", "05:57", "06:09", "06:21", "06:33", "06:45", "06:57", "07:09",
                    "07:21", "07:33", "07:45", "07:57", "08:09", "08:29", "08:49", "09:09", "09:29", "09:49",
                    "10:09", "10:29", "10:49", "11:09", "11:29", "11:49", "12:09", "12:29", "12:49", "13:09",
                    "13:29", "13:49", "14:09", "14:29", "14:49", "15:09", "15:29", "15:49", "16:09", "16:29",
                    "16:49", "17:09", "17:29", "17:49", "18:09", "18:29", "18:49", "19:09", "19:29", "19:49",
                    "20:09", "20:29", "20:49", "21:09", "21:29", "21:49", "22:09", "22:29", "22:49", "23:09",
                    "23:29", "23:49", "00:09", "00:19", "00:31"
                ],
                nakanoFujimicho: [
                    "08:24", "09:04", "09:44", "10:24", "11:04", "11:44", "12:24", "13:04", "13:44", "14:24",
                    "15:04", "15:44", "16:24", "17:04", "17:44", "18:24", "19:04", "19:44", "20:24", "21:04",
                    "21:44", "22:24", "23:04"
                ],
                myogadani: [
                    "08:19", "09:19", "10:19", "11:19", "12:19", "13:19", "14:19", "15:19", "16:19", "17:19",
                    "18:19", "19:19", "20:19", "21:19", "22:19", "23:19"
                ],
                ikebukuro: [
                    "08:39", "09:39", "10:39", "11:39", "12:39", "13:39", "14:39", "15:39", "16:39", "17:39",
                    "18:39", "19:39", "20:39", "21:39", "22:39", "23:39"
                ]
            }
        };

        let data = [];

        // 仮データの生成（リアルな時刻表を使用）
        function generateFallbackData() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const day = now.getDay();
            const isWeekday = day >= 1 && day <= 5;
            const schedule = isWeekday ? timetable.weekday : timetable.holiday;

            // 全ての列車を統合
            const allTrains = [];
            const destinations = [
                { key: 'honancho', ja: '方南町', en: 'Hōnanchō' },
                { key: 'nakanoSakaue', ja: '中野坂上', en: 'Nakano-Sakaue' },
                { key: 'nakanoFujimicho', ja: '中野富士見町', en: 'Nakano-Fujimicho' },
                { key: 'myogadani', ja: '茗荷谷', en: 'Myōgadani' },
                { key: 'ikebukuro', ja: '池袋', en: 'Ikebukuro' }
            ];

            destinations.forEach(dest => {
                schedule[dest.key].forEach(time => {
                    const [h, m] = time.split(':').map(Number);
                    allTrains.push({ time, hours: h, minutes: m, destination: { ja: dest.ja, en: dest.en } });
                });
            });

            // 現在時刻以降の直近4列車を選択
            const nowMinutes = hours * 60 + minutes;
            let trains = allTrains
                .map(train => {
                    let totalMinutes = train.hours * 60 + train.minutes;
                    if (totalMinutes < nowMinutes - 60) totalMinutes += 24 * 60;
                    return { ...train, totalMinutes };
                })
                .filter(train => train.totalMinutes >= nowMinutes)
                .sort((a, b) => a.totalMinutes - b.totalMinutes)
                .slice(0, 4);

            // 最終列車と乗継ぎ最終の処理
            const lastHonancho = schedule.honancho[schedule.honancho.length - 1]; // 0:21
            const lastNakanoSakaue = schedule.nakanoSakaue[schedule.nakanoSakaue.length - 1]; // 0:31
            const lastNakanoFujimicho = schedule.nakanoFujimicho[schedule.nakanoFujimicho.length - 1]; // 23:13平日、23:04土日祝
            const lastMyogadani = schedule.myogadani[schedule.myogadani.length - 1]; // 22:55平日、23:19土日祝
            const lastIkebukuro = schedule.ikebukuro[schedule.ikebukuro.length - 1]; // 23:01平日、23:39土日祝
            const connectionOgikubo = isWeekday ? "00:38" : "00:38"; // 乗継ぎ荻窪最終
            const connectionIkebukuro = isWeekday ? "00:35" : "00:35"; // 乗継ぎ池袋最終

            // データ生成（4行に制限）
            const fallback = [];
            trains.forEach(train => {
                const departureTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), train.hours, train.minutes);
                if (train.hours >= 24) departureTime.setDate(departureTime.getDate() + 1);

                let remarks = { ja: '', en: '' };
                if (train.time === lastHonancho && train.destination.ja === '方南町') {
                    remarks = { ja: '最終', en: 'Final' };
                } else if (train.time === lastNakanoFujimicho && train.destination.ja === '中野富士見町') {
                    remarks = { ja: '最終', en: 'Final' };
                } else if (train.time === lastNakanoSakaue && train.destination.ja === '中野坂上') {
                    const remarksOptions = [
                        { ja: '最終', en: 'Final' },
                        { ja: '中野坂上乗継ぎ荻窪行き最終', en: 'Last to Ogikubo via Nakano-Sakaue' },
                        { ja: '中野坂上乗継ぎ池袋行き最終', en: 'Last to Ikebukuro via Nakano-Sakaue' }
                    ];
                    const timeDiff = train.totalMinutes - nowMinutes;
                    const index = Math.min(Math.floor(timeDiff / 10) % 3, remarksOptions.length - 1);
                    remarks = remarksOptions[index];
                }

                fallback.push({
                    time: {
                        ja: train.time,
                        en: train.time
                    },
                    destination: train.destination,
                    remarks,
                    departureTime: departureTime.toISOString()
                });
            });

            return fallback;
        }

        const titleData = {
            ja: "Ⓜ MB05 丸ノ内線・中野新橋駅出発",
            en: "Ⓜ MB05 NAKANO-SHIMBASHI DEPARTURES"
        };

        let isJapanese = true;

        // フラップ更新（パタパタ演出を復活）
        function updateFlap(flap, newText) {
            if (!flap) return;
            const currentSpan = flap.querySelector('.current');
            const currentText = currentSpan ? currentSpan.textContent : '';
            if (currentText === newText) return; // 同じテキストなら更新不要

            const nextSpan = document.createElement('span');
            nextSpan.className = 'next';
            nextSpan.textContent = newText || '-';
            flap.appendChild(nextSpan);

            setTimeout(() => {
                if (currentSpan) currentSpan.className = 'prev';
                nextSpan.className = 'current';
                setTimeout(() => {
                    if (currentSpan) flap.removeChild(currentSpan);
                }, 200); // トランジション後に削除
            }, 50); // 少し遅らせてアニメーション開始

            return { flap, next: nextSpan };
        }

        // 日本語/英語切り替え（パタパタ演出付き）
        function updateSignage() {
            const lang = isJapanese ? 'ja' : 'en';
            document.querySelector('.signage').setAttribute('lang', lang);

            const updates = [];
            updates.push(updateFlap(document.getElementById('title'), titleData[lang]));

            for (let index = 0; index < 4; index++) {
                const train = data[index] || {};
                updates.push(updateFlap(document.getElementById(`time-${index}`), train.time?.[lang] || '-'));
                updates.push(updateFlap(document.getElementById(`destination-${index}`), train.destination?.[lang] || '-'));
                updates.push(updateFlap(document.getElementById(`remarks-${index}`), train.remarks?.[lang] || ''));
            }

            isJapanese = !isJapanese;
        }

        // 丸印の状態を更新
        function updateStatusIndicators() {
            const now = new Date();
            data.forEach((train, index) => {
                const statusFlap = document.getElementById(`status-${index}`);
                if (!statusFlap) return;
                const departureTime = new Date(train.departureTime);
                const timeDiff = (departureTime - now) / 1000 / 60;

                statusFlap.classList.remove('grey', 'orange', 'blink');
                if (timeDiff > 30) {
                    statusFlap.classList.add('grey');
                } else if (timeDiff > 20) {
                    statusFlap.classList.add('orange');
                } else {
                    statusFlap.classList.add('orange', 'blink');
                }
            });
        }

        // データと表示を更新
        function updateAll() {
            data = generateFallbackData();
            updateSignage();
            updateStatusIndicators();
        }

        // 初期化と定期更新
        function initialize() {
            updateAll();
            setInterval(updateAll, 60000); // 1分ごとにデータ更新
            setInterval(updateSignage, 5000); // 5秒ごとに言語切り替え（パタパタ）
            setInterval(updateStatusIndicators, 1000); // 1秒ごとに丸印更新
        }

        initialize();
    </script>
</body>
</html>