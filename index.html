<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中野新橋駅 フラップサイネージ</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #1a1a1a;
            font-family: 'Courier New', Courier, monospace;
        }
        .signage {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border-top: 5px solid #ff0000;
            width: 800px;
        }
        .signage[lang="ja"] {
            font-family: 'Yu Gothic', 'MS Gothic', sans-serif;
        }
        .signage[lang="en"] {
            font-family: 'Helvetica', 'Arial', sans-serif;
        }
        .title {
            font-size: 22px;
            font-weight: bold;
            color: #fff;
            text-align: center;
            margin-bottom: 20px;
            height: 30px;
            line-height: 30px;
        }
        .table {
            display: grid;
            gap: 5px;
        }
        .row {
            display: grid;
            grid-template-columns: 50px 120px 150px 150px 1fr;
            gap: 5px;
            min-height: 40px;
        }
        .header {
            color: #fff;
            font-size: 14px;
            text-align: center;
            margin-bottom: 2.5px;
            font-weight: bold;
        }
        .flap {
            height: 40px;
            background-color: #000;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            position: relative;
            overflow: hidden;
            border: 1px solid #444;
            text-align: center;
        }
        .flap[id^="time-"] {
            font-size: 20px;
            font-family: 'Helvetica', 'Arial', sans-serif;
        }
        .flap.status {
            width: 50px;
            font-size: 24px;
        }
        .flap span {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
            text-align: center;
        }
        .flap span.next {
            transform: translateY(-100%);
        }
        .flap span.current {
            transform: translateY(0);
        }
        .flap span.prev {
            transform: translateY(100%);
        }
        .status.grey span {
            color: #999;
        }
        .status.orange span {
            color: #ff6200;
        }
        .status.blink span {
            animation: blink 1.5s ease-in-out infinite;
        }
        .row.alert .flap {
            background-color: #ff0000;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        #debug-log {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #fff;
            color: #000;
            padding: 10px;
            max-height: 200px;
            overflow-y: scroll;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="signage" lang="ja">
        <div class="title" id="title"><span class="current">Ⓜ MB05 丸ノ内線・中野新橋駅出発</span></div>
        <div class="table">
            <div class="row">
                <div class="header"></div>
                <div class="header">発車時刻</div>
                <div class="header">行先</div>
                <div class="header">種別</div>
                <div class="header">備考</div>
            </div>
            <div class="row" id="row-0">
                <div class="flap status" id="status-0"><span class="current">●</span></div>
                <div class="flap" id="time-0"><span class="current">-</span></div>
                <div class="flap" id="destination-0"><span class="current">-</span></div>
                <div class="flap" id="train-type-0"><span class="current">-</span></div>
                <div class="flap" id="remarks-0"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-1">
                <div class="flap status" id="status-1"><span class="current">●</span></div>
                <div class="flap" id="time-1"><span class="current">-</span></div>
                <div class="flap" id="destination-1"><span class="current">-</span></div>
                <div class="flap" id="train-type-1"><span class="current">-</span></div>
                <div class="flap" id="remarks-1"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-2">
                <div class="flap status" id="status-2"><span class="current">●</span></div>
                <div class="flap" id="time-2"><span class="current">-</span></div>
                <div class="flap" id="destination-2"><span class="current">-</span></div>
                <div class="flap" id="train-type-2"><span class="current">-</span></div>
                <div class="flap" id="remarks-2"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-3">
                <div class="flap status" id="status-3"><span class="current">●</span></div>
                <div class="flap" id="time-3"><span class="current">-</span></div>
                <div class="flap" id="destination-3"><span class="current">-</span></div>
                <div class="flap" id="train-type-3"><span class="current">-</span></div>
                <div class="flap" id="remarks-3"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-4">
                <div class="flap status" id="status-4"><span class="current">●</span></div>
                <div class="flap" id="time-4"><span class="current">-</span></div>
                <div class="flap" id="destination-4"><span class="current">-</span></div>
                <div class="flap" id="train-type-4"><span class="current">-</span></div>
                <div class="flap" id="remarks-4"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-5">
                <div class="flap status" id="status-5"><span class="current">●</span></div>
                <div class="flap" id="time-5"><span class="current">-</span></div>
                <div class="flap" id="destination-5"><span class="current">-</span></div>
                <div class="flap" id="train-type-5"><span class="current">-</span></div>
                <div class="flap" id="remarks-5"><span class="current">-</span></div>
            </div>
        </div>
    </div>
    <div id="debug-log"></div>

    <script>
        // フォールバックデータの生成（現在時刻に基づく）
        function generateFallbackData() {
            const now = new Date();
            const baseMinutes = now.getMinutes();
            const baseHours = now.getHours();
            const fallback = [];

            for (let i = 0; i < 6; i++) {
                const minutes = (baseMinutes + i * 5) % 60;
                const hours = baseHours + Math.floor((baseMinutes + i * 5) / 60);
                const departureTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                
                fallback.push({
                    time: {
                        ja: departureTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
                        en: departureTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })
                    },
                    destination: {
                        ja: i % 2 === 0 ? '方南町' : '中野坂上',
                        en: i % 2 === 0 ? 'Hōnanchō' : 'Nakano-Sakaue'
                    },
                    trainType: {
                        ja: '各駅停車',
                        en: 'Local'
                    },
                    remarks: {
                        ja: '定刻',
                        en: 'On Time'
                    },
                    departureTime: departureTime.toISOString(),
                    hasPersonalInjury: false
                });
            }
            return fallback;
        }

        const fallbackData = generateFallbackData();

        const titleData = {
            ja: "Ⓜ MB05 丸ノ内線・中野新橋駅出発",
            en: "Ⓜ MB05 NAKANO-SHIMBASHI DEPARTURES"
        };

        let isJapanese = true;
        let data = [];
        let hasPersonalInjuryGlobal = false;

        // 画面ログ出力
        function logToScreen(message) {
            const debugLog = document.getElementById('debug-log');
            debugLog.innerHTML += `<p>${new Date().toISOString()}: ${message}</p>`;
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        // 遅延や人身事故情報を取得
        async function fetchTrainInformation() {
            const apiKey = '新しいAPIキー'; // ここに新しいAPIキーを入力してください
            const url = `https://api.odpt.org/api/v4/odpt:TrainInformation?odpt:railway=odpt.Railway:TokyoMetro.Marunouchi&acl:consumerKey=${apiKey}`;

            try {
                logToScreen(`遅延情報取得中: ${url}`);
                const response = await fetch(url);
                logToScreen(`遅延情報ステータス: ${response.status} ${response.statusText}`);
                if (!response.ok) {
                    throw new Error(`遅延情報リクエスト失敗: ${response.status} ${response.statusText}`);
                }
                const info = await response.json();
                logToScreen(`遅延情報レスポンス: ${JSON.stringify(info)}`);

                hasPersonalInjuryGlobal = info.some(item => 
                    item['odpt:trainInformationText'] && 
                    item['odpt:trainInformationText']['ja']?.includes('人身事故')
                );
                logToScreen(`人身事故発生: ${hasPersonalInjuryGlobal}`);
            } catch (error) {
                logToScreen(`遅延情報の取得エラー: ${error.message}`);
                hasPersonalInjuryGlobal = false;
            }
        }

        // APIからリアルタイムデータを取得
        async function fetchTrainData() {
            const apiKey = 'yjz1o1qfnro1og8dqpjhhme045c212o4ma6pxszots8zrfcus3v9x3l8977hm7mw'; // ここに新しいAPIキーを入力してください
            const useTimetable = true;
            // ステーションIDをMarunouchiBranchに修正
            const url = useTimetable
                ? `https://api.odpt.org/api/v4/odpt:StationTimetable?odpt:station=odpt.Station:TokyoMetro.MarunouchiBranch.NakanoShimbashi&acl:consumerKey=${apiKey}`
                : `https://api.odpt.org/api/v4/odpt:Train?odpt:railway=odpt.Railway:TokyoMetro.Marunouchi&odpt:station=odpt.Station:TokyoMetro.MarunouchiBranch.NakanoShimbashi&acl:consumerKey=${apiKey}`;

            try {
                logToScreen(`データ取得中: ${url}`);
                const response = await fetch(url);
                logToScreen(`レスポンスステータス: ${response.status} ${response.statusText}`);
                if (!response.ok) {
                    const error = `APIリクエスト失敗: ${response.status} ${response.statusText}`;
                    logToScreen(error);
                    throw new Error(error);
                }
                const trains = await response.json();
                logToScreen(`APIレスポンス全体: ${JSON.stringify(trains)}`);

                const now = new Date();
                const newData = [];
                let count = 0;

                if (useTimetable) {
                    if (!trains || trains.length === 0) {
                        logToScreen('時刻表データが空です');
                        throw new Error('Empty timetable data');
                    }

                    for (const timetable of trains) {
                        const timetableObjects = timetable['odpt:stationTimetableObject'] || [];
                        if (!timetableObjects || timetableObjects.length === 0) {
                            logToScreen(`時刻表オブジェクトが空です: ${JSON.stringify(timetable)}`);
                            continue;
                        }

                        logToScreen(`時刻表オブジェクト数: ${timetableObjects.length}`);
                        for (const entry of timetableObjects) {
                            if (count >= 6) break;

                            const departureTimeStr = entry['odpt:departureTime'];
                            if (!departureTimeStr) {
                                logToScreen(`出発時刻なしでスキップ: ${JSON.stringify(entry)}`);
                                continue;
                            }

                            const [hours, minutes] = departureTimeStr.split(':').map(Number);
                            const departureTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                            if (departureTime < now) {
                                departureTime.setDate(departureTime.getDate() + 1);
                            }

                            const remarksJa = hasPersonalInjuryGlobal ? '⚠ 人身事故' : '定刻';
                            const remarksEn = hasPersonalInjuryGlobal ? '⚠ Personal Injury' : 'On Time';

                            const destinationStation = entry['odpt:destinationStation'] || '';
                            newData.push({
                                time: {
                                    ja: departureTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
                                    en: departureTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })
                                },
                                destination: {
                                    ja: destinationStation.includes('Honancho') ? '方南町' : '中野坂上',
                                    en: destinationStation.includes('Honancho') ? 'Hōnanchō' : 'Nakano-Sakaue'
                                },
                                trainType: {
                                    ja: '各駅停車',
                                    en: 'Local'
                                },
                                remarks: { ja: remarksJa, en: remarksEn },
                                departureTime: departureTime.toISOString(),
                                hasPersonalInjury: hasPersonalInjuryGlobal
                            });

                            count++;
                        }
                    }
                } else {
                    if (!trains || trains.length === 0) {
                        logToScreen('列車データが空です');
                        throw new Error('Empty train data');
                    }

                    logToScreen(`列車データ数: ${trains.length}`);
                    for (const train of trains) {
                        if (count >= 6) break;

                        const departureTimeStr = train['odpt:departureTime'];
                        if (!departureTimeStr) {
                            logToScreen(`出発時刻なしでスキップ: ${JSON.stringify(train)}`);
                            continue;
                        }

                        const departureTime = new Date(departureTimeStr);
                        if (isNaN(departureTime) || departureTime < now) {
                            logToScreen(`無効または過去の出発時刻: ${departureTimeStr}`);
                            continue;
                        }

                        const delay = train['odpt:delay'] || 0;
                        const status = train['odpt:trainStatus'] || 'Normal';
                        const cause = train['odpt:cause'] || '';
                        const hasPersonalInjury = cause.toLowerCase().includes('personal injury');
                        let remarksJa = hasPersonalInjury ? '⚠ 人身事故' : '定刻';
                        let remarksEn = hasPersonalInjury ? '⚠ Personal Injury' : 'On Time';

                        if (status === 'Cancelled' && !hasPersonalInjury) {
                            remarksJa = '運休';
                            remarksEn = 'Cancelled';
                        } else if (delay > 0 && !hasPersonalInjury) {
                            remarksJa = `遅延${delay}分`;
                            remarksEn = `Delayed ${delay}min`;
                        }

                        const destinationStation = train['odpt:destinationStation'] || '';
                        newData.push({
                            time: {
                                ja: departureTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
                                en: departureTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })
                            },
                            destination: {
                                ja: destinationStation.includes('Honancho') ? '方南町' : '中野坂上',
                                en: destinationStation.includes('Honancho') ? 'Hōnanchō' : 'Nakano-Sakaue'
                            },
                            trainType: {
                                ja: '各駅停車',
                                en: 'Local'
                            },
                            remarks: { ja: remarksJa, en: remarksEn },
                            departureTime: departureTime.toISOString(),
                            hasPersonalInjury
                        });

                        count++;
                    }
                }

                if (newData.length > 0) {
                    data = newData;
                    logToScreen(`${newData.length}件の列車データを取得: ${JSON.stringify(data[0])}`);
                } else {
                    logToScreen('近日中の列車が見つかりません。フォールバックデータを使用します。');
                    data = generateFallbackData();
                }
            } catch (error) {
                logToScreen(`列車データの取得エラー: ${error.message}`);
                console.error('列車データの取得エラー:', error);
                data = generateFallbackData();
            }

            updatePersonalInjuryAlerts();
        }

        // 人身事故アラートを更新
        function updatePersonalInjuryAlerts() {
            if (!data || data.length === 0) {
                logToScreen('データが空です。アラート更新をスキップ。');
                return;
            }
            data.forEach((train, index) => {
                const row = document.getElementById(`row-${index}`);
                if (!row) return;
                if (train.hasPersonalInjury) {
                    row.classList.add('alert');
                    logToScreen(`row-${index}にアラートを追加: 人身事故`);
                } else {
                    row.classList.remove('alert');
                    logToScreen(`row-${index}のアラートを解除`);
                }
            });
        }

        // 丸印の状態を更新
        function updateStatusIndicators() {
            if (!data || data.length === 0) {
                logToScreen('データが空です。ステータス更新をスキップ。');
                return;
            }
            const now = new Date();
            const currentTime = now.getTime();

            data.forEach((train, index) => {
                const statusFlap = document.getElementById(`status-${index}`);
                if (!statusFlap) return;
                const departureTime = new Date(train.departureTime);
                const timeDiff = (departureTime.getTime() - currentTime) / 1000 / 60;

                statusFlap.classList.remove('grey', 'orange', 'blink');

                if (timeDiff > 30) {
                    statusFlap.classList.add('grey');
                    logToScreen(`Status-${index}: グレー (>30分, ${timeDiff.toFixed(1)}分)`);
                } else if (timeDiff > 20) {
                    statusFlap.classList.add('orange');
                    logToScreen(`Status-${index}: オレンジ (20-30分, ${timeDiff.toFixed(1)}分)`);
                } else {
                    statusFlap.classList.add('orange', 'blink');
                    logToScreen(`Status-${index}: オレンジ点滅 (≤20分, ${timeDiff.toFixed(1)}分)`);
                }
            });
        }

        // フラップ更新
        function updateFlap(flap, newText) {
            if (!flap) return;
            const spans = flap.querySelectorAll('span');
            spans.forEach(span => flap.removeChild(span));

            const next = document.createElement('span');
            next.className = 'next';
            next.textContent = newText || '-';
            flap.appendChild(next);
            return { flap, next };
        }

        // 日本語/英語切り替え
        function updateSignage() {
            if (!data || data.length === 0) {
                logToScreen('データが空です。サイネージ更新をスキップ。');
                return;
            }
            const lang = isJapanese ? 'ja' : 'en';
            logToScreen(`${lang}に切り替え`);

            document.querySelector('.signage').setAttribute('lang', lang);

            const updates = [];
            const titleFlap = document.getElementById('title');
            updates.push(updateFlap(titleFlap, titleData[lang]));

            for (let index = 0; index < 6; index++) {
                const train = data[index] || {};
                updates.push(updateFlap(document.getElementById(`time-${index}`), train.time ? train.time[lang] : '-'));
                updates.push(updateFlap(document.getElementById(`destination-${index}`), train.destination ? train.destination[lang] : '-'));
                updates.push(updateFlap(document.getElementById(`train-type-${index}`), train.trainType ? train.trainType[lang] : '-'));
                updates.push(updateFlap(document.getElementById(`remarks-${index}`), train.remarks ? train.remarks[lang] : '-'));
            }

            requestAnimationFrame(() => {
                updates.forEach(({ flap, next }) => {
                    if (flap && next) {
                        next.className = 'current';
                        logToScreen(`${flap.id}を${next.textContent}に更新`);
                    }
                });
            });

            isJapanese = !isJapanese;
        }

        // 初期化と定期更新
        async function initialize() {
            await fetchTrainInformation();
            await fetchTrainData();
            if (data.length > 0) {
                updateSignage();
                updateStatusIndicators();
            } else {
                logToScreen('初期データがありません。フォールバックを使用。');
                data = generateFallbackData();
                updateSignage();
                updateStatusIndicators();
            }

            setInterval(updateSignage, 5000);
            setInterval(updateStatusIndicators, 1000);
            setInterval(async () => {
                await fetchTrainInformation();
                await fetchTrainData();
            }, 120000);
        }

        initialize();
    </script>
</body>
</html>