<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ⓜ️ 丸ノ内線・中野新橋駅出発</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #1a1a1a;
            font-family: 'Courier New', Courier, monospace;
        }
        .signage {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border-top: 5px solid #ff0000;
            width: 600px;
            transform: scale(1.1);
            transform-origin: top center;
        }
        .signage[lang="ja"] {
            font-family: 'Yu Gothic', 'MS Gothic', sans-serif;
        }
        .signage[lang="en"] {
            font-family: 'Helvetica', 'Arial', sans-serif;
        }
        .title {
            font-size: 22px;
            font-weight: bold;
            color: #fff;
            text-align: center;
            margin-bottom: 10px;
            height: 30px;
            line-height: 30px;
        }
        .title .metro-mark {
            font-size: 33px; /* 22px * 1.5 = 33px */
            vertical-align: middle;
        }
        .table {
            display: grid;
            gap: 5px;
        }
        .row {
            display: grid;
            grid-template-columns: 50px 120px 150px 1fr;
            gap: 5px;
            min-height: 40px;
        }
        .header {
            color: #fff;
            font-size: 14px;
            text-align: center;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .flap {
            height: 40px;
            background-color: #000;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            position: relative;
            overflow: hidden;
            border: 1px solid #444;
            text-align: center;
        }
        .flap[id^="time-"] {
            font-size: 22px;
            font-family: 'Helvetica', 'Arial', sans-serif;
        }
        .flap[id^="destination-"] {
            font-size: 20px;
        }
        .flap.status {
            width: 50px;
            font-size: 24px;
        }
        .flap:not(.title) span {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
            text-align: center;
        }
        .flap span.next {
            transform: translateY(-100%);
        }
        .flap span.current {
            transform: translateY(0);
        }
        .flap span.prev {
            transform: translateY(100%);
        }
        .status.grey span {
            color: #999;
        }
        .status.orange span {
            color: #ff6200;
        }
        .status.blink span {
            animation: blink 1.5s ease-in-out infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="signage" lang="ja">
        <div class="title" id="title"><span class="metro-mark">Ⓜ️</span> 丸ノ内線・中野新橋駅出発</div>
        <div class="table">
            <div class="row">
                <div class="header" id="header-status"></div>
                <div class="header" id="header-time">発車時刻</div>
                <div class="header" id="header-destination">行先</div>
                <div class="header" id="header-remarks">備考</div>
            </div>
            <div class="row" id="row-0">
                <div class="flap status" id="status-0"><span class="current">●</span></div>
                <div class="flap" id="time-0"><span class="current">-</span></div>
                <div class="flap" id="destination-0"><span class="current">-</span></div>
                <div class="flap" id="remarks-0"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-1">
                <div class="flap status" id="status-1"><span class="current">●</span></div>
                <div class="flap" id="time-1"><span class="current">-</span></div>
                <div class="flap" id="destination-1"><span class="current">-</span></div>
                <div class="flap" id="remarks-1"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-2">
                <div class="flap status" id="status-2"><span class="current">●</span></div>
                <div class="flap" id="time-2"><span class="current">-</span></div>
                <div class="flap" id="destination-2"><span class="current">-</span></div>
                <div class="flap" id="remarks-2"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-3">
                <div class="flap status" id="status-3"><span class="current">●</span></div>
                <div class="flap" id="time-3"><span class="current">-</span></div>
                <div class="flap" id="destination-3"><span class="current">-</span></div>
                <div class="flap" id="remarks-3"><span class="current">-</span></div>
            </div>
        </div>
    </div>

    <script>
        // 2025年の日本祝日リスト（固定。春分・秋分は簡易対応）
        const holidays2025 = [
            "2025-01-01", // 元日
            "2025-01-13", // 成人の日
            "2025-02-11", // 建国記念の日
            "2025-02-23", // 天皇誕生日
            "2025-04-29", // 昭和の日
            "2025-05-03", // 憲法記念日
            "2025-05-04", // みどりの日
            "2025-05-05", // こどもの日
            "2025-07-21", // 海の日
            "2025-08-11", // 山の日
            "2025-09-15", // 敬老の日
            "2025-09-23", // 秋分の日
            "2025-10-13", // 体育の日
            "2025-11-03", // 文化の日
            "2025-11-23", // 勤労感謝の日
            "2025-05-06", // こどもの日振替
            "2025-11-24" // 勤労感謝の日振替
        ];

        // 時刻表データ（平日、休日ごと。枝番追加）
        const timetable = {
            weekday: {
                honancho: [
                    "05:11", "05:31", "05:44", "05:55", "06:04", "06:16", "06:23", "06:30", "06:37", "06:44",
                    "06:49", "06:56", "07:04", "07:11", "07:18", "07:25", "07:30", "07:33",
                    "07:39", "07:48", "07:56", "08:04", "08:08", "08:16", "08:23", "08:30", "08:35",
                    "08:40", "08:44", "08:49", "08:54", "09:02", "09:07", "09:12", "09:18", "09:23", "09:28", "09:33", "09:37", "09:47", "09:57",
                    "10:05", "10:07", "10:16", "10:27", "10:35", "10:37", "10:46", "10:56", "10:59",
                    "11:04", "11:15", "11:24", "11:35", "11:43", "11:49", "11:58", "12:09", "12:19", "12:28",
                    "12:38", "12:43", "12:49", "12:58", "13:09", "13:19", "13:28", "13:38",
                    "13:44", "13:49", "13:58", "14:09", "14:16", "14:26", "14:37", "14:44", "14:49", "14:58",
                    "15:04", "15:14", "15:22", "15:33", "15:44", "15:48", "15:56", "16:06", "16:12", "16:17",
                    "16:26", "16:34", "16:40", "16:47", "16:53", "17:01", "17:06", "17:14", "17:21", "17:26", "17:33",
                    "17:41", "17:46", "17:53", "18:01", "18:06", "18:13", "18:21", "18:26", "18:33", "18:41", "18:46",
                    "18:53", "19:01", "19:06", "19:13", "19:21", "19:26", "19:33", "19:41", "19:46", "19:53", "19:58", "20:01", "20:07",
                    "20:13", "20:18", "20:23", "20:28", "20:37", "20:42", "20:47", "20:54", "20:56", "21:02", "21:06", "21:10", "21:13", "21:18", "21:25", "21:32",
                    "21:34", "21:41", "21:49", "21:56", "21:58", "22:03", "22:09", "22:14", "22:21", "22:30", "22:38", "22:47",
                    "22:54", "23:00", "23:02", "23:11", "23:16", "23:18", "23:27", "23:32", "23:37", "23:43", "23:49", "23:54", "00:04", "00:10", "00:21"
                ],
                nakanoSakaue: [
                    "05:04", "05:22", "05:33", "05:46", "05:56", "06:07", "06:15", "06:22", "06:29", "06:36", "06:41",
                    "06:48", "06:51", "06:55", "07:01", "07:07", "07:17", "07:22", "07:31", "07:36", "07:47", "07:55",
                    "09:18", "09:29", "09:39", "09:49", "09:58",
                    "10:08", "10:19", "10:27", "10:38", "10:47", "11:07", "11:12", "11:27",
                    "11:38", "11:47", "12:07", "12:16", "12:30", "12:39",
                    "12:50", "13:07", "13:15", "13:30", "13:39", "13:50",
                    "14:07", "14:16", "14:29", "14:39", "14:50", "15:06", "15:12", "15:25",
                    "15:34", "15:46", "15:55", "16:07", "16:18", "16:32", "16:38",
                    "16:52", "17:12", "17:32", "17:52",
                    "18:12", "18:32", "18:52", "19:12", "19:32",
                    "19:53", "19:59", "20:10", "20:19", "20:29", "20:39",
                    "20:48", "20:54", "21:00", "21:09", "21:16", "21:22", "21:31", "21:38", "21:47", "21:55",
                    "22:03", "22:11", "22:18", "22:27", "22:35", "22:44", "22:53", "22:59", "23:03", "23:08", "23:16",
                    "23:23", "23:31", "23:41", "23:58", "00:13"
                ],
                nakanoFujimicho: [
                    "08:58", "09:25", "09:35", "09:40", "09:44", "09:49", "09:54", "10:00", "10:09", "10:14", "10:20", "10:30", "10:42", "10:49",
                    "00:00", "00:14", "00:25", "00:28"
                ],
                myogadani: [
                    "08:29", "08:46"
                ],
                ikebukuro: [
                    "05:28", "05:40", "05:52", "06:02", "06:10", "06:18", "06:26", "06:39", "07:45", "06:46", "06:53", "06:59", "07:04", "07:10", "07:15", "07:24", "07:29", "07:34", "07:40", "07:44", "07:51", "08:02", "08:08", "08:15", "08:22", "08:36", "08:42", "08:51", "08:55", "09:00", "09:07", "09:13", "09:24", "09:34", "09:46", "10:17", "10:57", "11:18", "11:58", "12:22",
                    "12:58", "13:22", "13:58", "14:22", "14:58", "15:17", "15:23", "15:29", "15:41", "15:50", "16:02", "16:09", "16:14", "16:20", "16:26", "16:30", "16:35", "16:43", "16:48", "16:58", "17:05", "17:18", "17:25", "17:38", "17:45", "17:58", "18:05",
                    "18:18", "18:25", "18:38", "18:45", "18:58", "19:05", "19:18", "19:25", "19:38", "19:46"
                ],
                shinjukuSanchome: [
                    "05:01", "05:14"
                ]
            },
            holiday: {
                honancho: [
                    "05:11", "05:31", "05:43", "05:52", "06:00", "06:10", "06:18", "06:28", "06:36", "06:45", "06:53", "07:00", "07:07", "07:16", "07:24",
                    "07:32", "07:40", "07:46", "07:53", "08:00", "08:07", "08:09", "08:15", "08:22", "08:29", "08:36", "08:39", "08:45", "08:52", "08:59",
                    "09:06", "09:09", "09:15", "09:23", "09:30", "09:38", "09:43", "09:46", "09:53", "10:00", "10:09", "10:18", "10:28",
                    "10:38", "10:44", "10:51", "11:00", "11:09", "11:18", "11:28", "11:38", "11:43", "11:51", "12:00", "12:09",
                    "12:18", "12:28", "12:38", "12:43", "12:52", "13:01", "13:09", "13:19", "13:28", "12:38", "13:43", "12:48", "13:58",
                    "14:09", "14:19", "14:28", "14:38", "14:43", "14:52", "14:58", "15:08", "15:19", "15:28", "15:38",
                    "15:43", "15:50", "15:58", "16:09", "16:19", "16:28", "16:38", "16:43", "16:49", "16:58", "17:09", "17:19",
                    "17:28", "17:38", "17:43", "17:49", "17:58", "18:09", "18:19", "18:28", "18:38", "18:43", "18:49", "18:58",
                    "19:09", "19:19", "19:28", "19:38", "19:43", "19:49", "19:58", "20:09", "20:19", "20:28", "20:38",
                    "20:43", "20:49", "20:58", "21:09", "21:19", "21:29", "21:38", "21:48", "21:50", "21:59", "22:08", "22:18",
                    "22:23", "22:30", "22:38", "22:46", "22:51", "22:54", "22:59", "23:05", "23:09", "23:16", "23:26", "23:35", "23:42", "23:48", "23:54", "23:57",
                    "00:10", "00:21"
                ],
                nakanoSakaue: [
                    "05:04", "05:21", "05:32", "05:42", "05:51", "06:01", "06:09", "06:19", "06:27", "06:37", "06:42", "06:49", "06:59", "07:06",
                    "07:13", "07:23", "07:30", "07:37", "07:44", "07:52", "07:58", "08:05", "08:12", "08:19", "08:27", "08:35", "08:42", "08:49", "08:57", "09:05", "09:12", "09:20", "09:29", "09:36", "09:44", "09:50",
                    "10:08", "10:15", "10:30", "10:39", "10:50", "11:06", "11:15", "11:30", "11:39", "11:50", "12:07", "12:15", "12:30", "12:39", "12:50", "13:07",
                    "13:16", "13:30", "13:39", "13:50", "14:07", "14:16", "14:30", "14:39", "14:50", "15:07", "15:16", "15:30", "15:39", "15:50", "16:07", "16:16", "16:30", "16:39", "16:30",
                    "16:39", "16:50", "17:07", "17:16", "17:30", "17:39", "17:50", "18:07", "18:16", "18:30", "18:39", "18:50", "19:07", "19:16", "19:30", "19:39", "19:50",
                    "20:07", "20:16", "20:30", "20:39", "20:50", "21:07", "21:16", "21:30", "21:41", "21:50", "22:10", "22:19", "22:30", "22:36", "22:43", "22:51", "22:57", "23:07",
                    "23:18", "23:27", "23:37", "23:47", "00:00", "00:13"
                ],
                nakanoFujimicho: [
                    "00:02", "00:25", "00:28"
                ],
                myogadani: [],
                ikebukuro: [
                    "05:58", "06:15", "06:52", "07:16", "08:23", "08:53", "09:23", "09:58", "10:22", "10:57", "11:22", "11:58", "12:22", "12:58", "13:22", "13:58", "14:22", "14:58", "15:22", "15:58", "16:22", "16:58", "17:22", "17:58",
                    "18:22", "18:58", "19:22", "19:58", "20:23", "20:58", "21:22", "22:02"
                ],
                shinjukuSanchome: [
                    "05:01", "05:14"
                ]
            }
        };

        let data = [];

        // フォールバックデータ生成（現在時刻+3分以降の列車を抽出）
        function generateFallbackData() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const day = now.getDay();
            const todayStr = now.toISOString().split('T')[0]; // 例: "2025-04-29"
            const isHoliday = holidays2025.includes(todayStr) || day === 0 || day === 6; // 祝日または土日
            const schedule = isHoliday ? timetable.holiday : timetable.weekday;

            // 全ての列車を統合
            const allTrains = [];
            const destinations = [
                { key: 'honancho', ja: '方南町', en: 'Hōnanchō' },
                { key: 'nakanoSakaue', ja: '中野坂上', en: 'Nakano-Sakaue' },
                { key: 'nakanoFujimicho', ja: '中野富士見町', en: 'Nakano-Fujimicho' },
                { key: 'myogadani', ja: '茗荷谷', en: 'Myōgadani' },
                { key: 'ikebukuro', ja: '池袋', en: 'Ikebukuro' },
                { key: 'shinjukuSanchome', ja: '新宿三丁目', en: 'Shinjuku-Sanchōme' }
            ];

            destinations.forEach(dest => {
                schedule[dest.key].forEach(time => {
                    const [h, m] = time.split(':').map(Number);
                    allTrains.push({ time, hours: h, minutes: m, destination: { ja: dest.ja, en: dest.en } });
                });
            });

            // 現在時刻+3分以降の直近4列車を選択
            const nowMinutes = hours * 60 + minutes;
            let trains = allTrains
                .map(train => {
                    let totalMinutes = train.hours * 60 + train.minutes;
                    if (totalMinutes < nowMinutes - 60) totalMinutes += 24 * 60;
                    return { ...train, totalMinutes };
                })
                .filter(train => train.totalMinutes >= nowMinutes + 3) // 3分前に消える
                .sort((a, b) => a.totalMinutes - b.totalMinutes)
                .slice(0, 4);

            // デバッグログ
            console.log('Generated trains:', trains);

            // データが空の場合、空行を補充
            while (trains.length < 4) {
                trains.push({
                    time: '-',
                    destination: { ja: '-', en: '-' },
                    remarks: { ja: '', en: '' },
                    totalMinutes: Infinity
                });
            }

            // 最終列車と終点の最終情報を取得
            const lastHonancho = schedule.honancho[schedule.honancho.length - 1]; // 0:21
            const lastNakanoSakaue = schedule.nakanoSakaue[schedule.nakanoSakaue.length - 1]; // 0:13
            const lastNakanoFujimicho = schedule.nakanoFujimicho[schedule.nakanoFujimicho.length - 1]; // 0:28
            const lastMyogadani = schedule.myogadani[schedule.myogadani.length - 1] || '23:59';
            const lastIkebukuro = schedule.ikebukuro[schedule.ikebukuro.length - 1] || '23:59';
            const lastShinjukuSanchome = schedule.shinjukuSanchome[schedule.shinjukuSanchome.length - 1] || '23:59';

            // データ生成（4行に整形）
            const fallback = [];
            trains.forEach(train => {
                if (train.time === '-') {
                    fallback.push({
                        time: { ja: '-', en: '-' },
                        destination: { ja: '-', en: '-' },
                        remarks: { ja: '', en: '' },
                        departureTime: null
                    });
                    return;
                }

                const departureTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), train.hours, train.minutes);
                if (train.hours >= 24) departureTime.setDate(departureTime.getDate() + 1);

                let remarks = { ja: '', en: '' };
                if (train.time === lastHonancho && train.destination.ja === '方南町') {
                    remarks = { ja: '最終', en: 'Final' };
                } else if (train.time === lastNakanoFujimicho && train.destination.ja === '中野富士見町') {
                    remarks = { ja: '最終', en: 'Final' };
                } else if (train.time === lastNakanoSakaue && train.destination.ja === '中野坂上') {
                    remarks = { ja: '最終', en: 'Final' };
                } else if (train.time === '23:41' && train.destination.ja === '中野坂上') {
                    remarks = { ja: '中野坂上経由池袋行最終', en: 'Last to Ikebukuro via Nakano-Sakaue' };
                } else if (train.time === '23:58' && train.destination.ja === '中野坂上') {
                    remarks = { ja: '中野坂上経由新宿三丁目行最終', en: 'Last to Shinjuku-Sanchōme via Nakano-Sakaue' };
                } else if (train.time === '00:13' && train.destination.ja === '中野坂上') {
                    remarks = { ja: '中野坂上経由荻窪行最終', en: 'Last to Ogikubo via Nakano-Sakaue' };
                }

                fallback.push({
                    time: { ja: train.time, en: train.time },
                    destination: train.destination,
                    remarks,
                    departureTime: departureTime.toISOString()
                });
            });

            return fallback;
        }

        const titleData = {
            ja: "<span class='metro-mark'>Ⓜ️</span> 丸ノ内線・中野新橋駅出発",
            en: "<span class='metro-mark'>Ⓜ️</span> MB05 NAKANO-SHIMBASHI DEPARTURES"
        };

        const headerData = {
            ja: { time: "発車時刻", destination: "行先", remarks: "備考" },
            en: { time: "Departure", destination: "Destination", remarks: "Remarks" }
        };

        let isJapanese = true;

        // フラップ更新
        function updateFlap(flap, newText) {
            if (!flap) {
                console.error('Flap element not found');
                return;
            }
            while (flap.firstChild) {
                flap.removeChild(flap.firstChild);
            }
            const span = document.createElement('span');
            span.className = 'current';
            span.innerHTML = newText || '-';
            flap.appendChild(span);
            return { flap, span };
        }

        // 日本語/英語切り替え（定期的に切り替え）
        function updateSignage() {
            const lang = isJapanese ? 'ja' : 'en';
            document.querySelector('.signage').setAttribute('lang', lang);

            const updates = [];
            updates.push(updateFlap(document.getElementById('title'), titleData[lang]));
            updates.push(updateFlap(document.getElementById('header-time'), headerData[lang].time));
            updates.push(updateFlap(document.getElementById('header-destination'), headerData[lang].destination));
            updates.push(updateFlap(document.getElementById('header-remarks'), headerData[lang].remarks));

            for (let index = 0; index < 4; index++) {
                const train = data[index] || {};
                updates.push(updateFlap(document.getElementById(`time-${index}`), train.time?.[lang] || '-'));
                updates.push(updateFlap(document.getElementById(`destination-${index}`), train.destination?.[lang] || '-'));
                updates.push(updateFlap(document.getElementById(`remarks-${index}`), train.remarks?.[lang] || ''));
                const statusFlap = document.getElementById(`status-${index}`);
                if (statusFlap) {
                    updateFlap(statusFlap, train.time?.[lang] === '-' ? '-' : '●');
                }
            }

            requestAnimationFrame(() => {
                updates.forEach(({ flap, span }) => {
                    if (flap && span) span.className = 'current';
                });
            });

            isJapanese = !isJapanese;
            console.log('Signage updated, lang:', lang);
        }

        // 案内状況を更新
        function updateStatusIndicators() {
            const now = new Date();
            data.forEach((train, index) => {
                const statusFlap = document.getElementById(`status-${index}`);
                if (!statusFlap || !train.departureTime) return;
                const departureTime = new Date(train.departureTime);
                const timeDiff = (departureTime - now) / 1000 / 60;

                statusFlap.classList.remove('grey', 'orange', 'blink');
                if (timeDiff > 30) {
                    statusFlap.classList.add('grey');
                } else if (timeDiff > 20) {
                    statusFlap.classList.add('orange');
                } else {
                    statusFlap.classList.add('orange', 'blink');
                }
            });
        }

        // データと表示を更新
        function updateAll() {
            try {
                data = generateFallbackData();
                updateSignage();
                updateStatusIndicators();
                console.log('Update completed, data:', data);
            } catch (error) {
                console.error('Error in updateAll:', error);
            }
        }

        // 初期化と定期更新
        function initialize() {
            try {
                updateAll();
                setInterval(updateAll, 60000); // 1分ごとにデータ更新
                setInterval(updateSignage, 5000); // 5秒ごとに言語切り替え
                setInterval(updateStatusIndicators, 1000); // 1秒ごとに案内更新
                console.log('Initialized');
            } catch (error) {
                console.error('Error in initialize:', error);
            }
        }

        initialize();
    </script>
</body>
</html>