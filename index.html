<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中野新橋駅 フラップサイネージ</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #1a1a1a;
            font-family: 'Courier New', Courier, monospace;
        }
        .signage {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border-top: 5px solid #ff0000;
            width: 800px;
        }
        .signage[lang="ja"] {
            font-family: 'Yu Gothic', 'MS Gothic', sans-serif;
        }
        .signage[lang="en"] {
            font-family: 'Helvetica', 'Arial', sans-serif;
        }
        .title {
            font-size: 22px;
            font-weight: bold;
            color: #fff;
            text-align: center;
            margin-bottom: 20px;
            height: 30px;
            line-height: 30px;
        }
        .table {
            display: grid;
            gap: 5px;
        }
        .row {
            display: grid;
            grid-template-columns: 50px 120px 150px 150px 1fr;
            gap: 5px;
            min-height: 40px;
        }
        .header {
            color: #fff;
            font-size: 14px;
            text-align: center;
            margin-bottom: 2.5px;
            font-weight: bold;
        }
        .flap {
            height: 40px;
            background-color: #000;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            position: relative;
            overflow: hidden;
            border: 1px solid #444;
            text-align: center;
        }
        .flap[id^="time-"] {
            font-size: 20px;
            font-family: 'Helvetica', 'Arial', sans-serif;
        }
        .flap.status {
            width: 50px;
            font-size: 24px;
        }
        .flap span {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
            text-align: center;
        }
        .flap span.next {
            transform: translateY(-100%);
        }
        .flap span.current {
            transform: translateY(0);
        }
        .flap span.prev {
            transform: translateY(100%);
        }
        .status.grey span {
            color: #999;
        }
        .status.orange span {
            color: #ff6200;
        }
        .status.blink span {
            animation: blink 1.5s ease-in-out infinite;
        }
        .row.alert .flap {
            background-color: #ff0000;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        #debug-log {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #fff;
            color: #000;
            padding: 10px;
            max-height: 200px;
            overflow-y: scroll;
            font-size: 12px;
            opacity: 0.8; /* 視認性向上 */
        }
    </style>
</head>
<body>
    <div class="signage" lang="ja">
        <div class="title" id="title"><span class="current">Ⓜ MB05 丸ノ内線・中野新橋駅出発</span></div>
        <div class="table">
            <div class="row">
                <div class="header"></div>
                <div class="header">発車時刻</div>
                <div class="header">行先</div>
                <div class="header">種別</div>
                <div class="header">備考</div>
            </div>
            <div class="row" id="row-0">
                <div class="flap status" id="status-0"><span class="current">●</span></div>
                <div class="flap" id="time-0"><span class="current">-</span></div>
                <div class="flap" id="destination-0"><span class="current">-</span></div>
                <div class="flap" id="train-type-0"><span class="current">-</span></div>
                <div class="flap" id="remarks-0"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-1">
                <div class="flap status" id="status-1"><span class="current">●</span></div>
                <div class="flap" id="time-1"><span class="current">-</span></div>
                <div class="flap" id="destination-1"><span class="current">-</span></div>
                <div class="flap" id="train-type-1"><span class="current">-</span></div>
                <div class="flap" id="remarks-1"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-2">
                <div class="flap status" id="status-2"><span class="current">●</span></div>
                <div class="flap" id="time-2"><span class="current">-</span></div>
                <div class="flap" id="destination-2"><span class="current">-</span></div>
                <div class="flap" id="train-type-2"><span class="current">-</span></div>
                <div class="flap" id="remarks-2"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-3">
                <div class="flap status" id="status-3"><span class="current">●</span></div>
                <div class="flap" id="time-3"><span class="current">-</span></div>
                <div class="flap" id="destination-3"><span class="current">-</span></div>
                <div class="flap" id="train-type-3"><span class="current">-</span></div>
                <div class="flap" id="remarks-3"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-4">
                <div class="flap status" id="status-4"><span class="current">●</span></div>
                <div class="flap" id="time-4"><span class="current">-</span></div>
                <div class="flap" id="destination-4"><span class="current">-</span></div>
                <div class="flap" id="train-type-4"><span class="current">-</span></div>
                <div class="flap" id="remarks-4"><span class="current">-</span></div>
            </div>
            <div class="row" id="row-5">
                <div class="flap status" id="status-5"><span class="current">●</span></div>
                <div class="flap" id="time-5"><span class="current">-</span></div>
                <div class="flap" id="destination-5"><span class="current">-</span></div>
                <div class="flap" id="train-type-5"><span class="current">-</span></div>
                <div class="flap" id="remarks-5"><span class="current">-</span></div>
            </div>
        </div>
    </div>
    <div id="debug-log"></div>

    <script>
        // フォールバックデータの生成（実際の時刻表を模倣）
        function generateFallbackData() {
            const now = new Date();
            const baseHours = now.getHours();
            const baseMinutes = now.getMinutes();
            const fallback = [];

            // 丸ノ内線中野新橋駅の実際の運用パターンを模倣（例: 5-10分間隔）
            const sampleTimes = [0, 5, 10, 15, 20, 25]; // 分単位の出発時刻オフセット
            const destinations = [
                { ja: '方南町', en: 'Hōnanchō' },
                { ja: '中野坂上', en: 'Nakano-Sakaue' },
                { ja: '池袋', en: 'Ikebukuro' } // 丸ノ内線本線の例
            ];

            for (let i = 0; i < 6; i++) {
                const minutes = (baseMinutes + sampleTimes[i % sampleTimes.length]) % 60;
                const hours = baseHours + Math.floor((baseMinutes + sampleTimes[i]) / 60);
                const departureTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);

                fallback.push({
                    time: {
                        ja: departureTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
                        en: departureTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })
                    },
                    destination: destinations[i % destinations.length],
                    trainType: {
                        ja: '各駅停車',
                        en: 'Local'
                    },
                    remarks: {
                        ja: i === 1 ? '⚠ 遅延5分' : '定刻',
                        en: i === 1 ? '⚠ Delayed 5min' : 'On Time'
                    },
                    departureTime: departureTime.toISOString(),
                    hasPersonalInjury: i === 1
                });
            }
            return fallback;
        }

        const fallbackData = generateFallbackData();

        const titleData = {
            ja: "Ⓜ MB05 丸ノ内線・中野新橋駅出発",
            en: "Ⓜ MB05 NAKANO-SHIMBASHI DEPARTURES"
        };

        let isJapanese = true;
        let data = [];

        // 画面ログ出力（簡潔化）
        function logToScreen(message) {
            const debugLog = document.getElementById('debug-log');
            debugLog.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${message}</p>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            // ログを最新10件に制限
            const logs = debugLog.getElementsByTagName('p');
            while (logs.length > 10) debugLog.removeChild(logs[0]);
        }

        // APIからリアルタイムデータを取得
        async function fetchTrainData() {
            // セキュリティのためAPIキーは環境変数等で管理すべき（今回は仮置き）
            const apiKey = 'yovqdy1by3b4lczf765jijnttqtyp3lvgj6v3pntfbz2l36qbmbww896vi1irk7p'; // 実際には環境変数等を使用
            const timetableUrl = `https://api.odpt.org/api/v4/odpt:StationTimetable?odpt:station=odpt.Station:TokyoMetro.Marunouchi.NakanoShimbashi&acl:consumerKey=${apiKey}`;
            const trainUrl = `https://api.odpt.org/api/v4/odpt:Train?odpt:railway=odpt.Railway:TokyoMetro.Marunouchi&odpt:station=odpt.Station:TokyoMetro.Marunouchi.NakanoShimbashi&acl:consumerKey=${apiKey}`;

            try {
                logToScreen('時刻表データを取得中...');
                const timetableResponse = await fetch(timetableUrl);
                if (!timetableResponse.ok) throw new Error(`時刻表APIエラー: ${timetableResponse.status}`);

                const timetableData = await timetableResponse.json();
                if (!timetableData || timetableData.length === 0) {
                    logToScreen('時刻表データが空です');
                    throw new Error('Empty timetable data');
                }

                const now = new Date();
                const newData = [];
                let count = 0;

                // 時刻表データを処理
                for (const timetable of timetableData) {
                    const timetableObjects = timetable['odpt:stationTimetableObject'] || [];
                    if (!timetableObjects.length) {
                        logToScreen('時刻表オブジェクトが空です');
                        continue;
                    }

                    for (const entry of timetableObjects) {
                        if (count >= 6) break;

                        const departureTimeStr = entry['odpt:departureTime'];
                        if (!departureTimeStr) continue;

                        const [hours, minutes] = departureTimeStr.split(':').map(Number);
                        let departureTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                        if (departureTime < now) departureTime.setDate(departureTime.getDate() + 1);

                        const destinationStation = entry['odpt:destinationStation'] || '';
                        const destination = {
                            ja: destinationStation.includes('Honancho') ? '方南町' :
                                destinationStation.includes('NakanoSakaue') ? '中野坂上' :
                                destinationStation.includes('Ikebukuro') ? '池袋' : '不明',
                            en: destinationStation.includes('Honancho') ? 'Hōnanchō' :
                                destinationStation.includes('NakanoSakaue') ? 'Nakano-Sakaue' :
                                destinationStation.includes('Ikebukuro') ? 'Ikebukuro' : 'Unknown'
                        };

                        newData.push({
                            time: {
                                ja: departureTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
                                en: departureTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })
                            },
                            destination,
                            trainType: {
                                ja: '各駅停車',
                                en: 'Local'
                            },
                            remarks: { ja: '定刻', en: 'On Time' },
                            departureTime: departureTime.toISOString(),
                            hasPersonalInjury: false,
                            trainId: entry['odpt:train'] || '' // 列車識別子
                        });

                        count++;
                    }
                }

                // リアルタイムデータを取得して遅延・運休情報を反映
                logToScreen('リアルタイムデータを取得中...');
                const trainResponse = await fetch(trainUrl);
                if (trainResponse.ok) {
                    const trainData = await trainResponse.json();
                    if (trainData && trainData.length > 0) {
                        for (const train of trainData) {
                            const trainId = train['odpt:train'] || '';
                            const target = newData.find(item => item.trainId === trainId);
                            if (target) {
                                const delay = train['odpt:delay'] || 0;
                                const status = train['odpt:trainStatus'] || 'Normal';
                                const cause = train['odpt:cause'] || '';
                                target.hasPersonalInjury = cause.toLowerCase().includes('personal injury');

                                if (status === 'Cancelled') {
                                    target.remarks = { ja: '運休', en: 'Cancelled' };
                                } else if (delay > 0) {
                                    target.remarks = { ja: `遅延${delay}分`, en: `Delayed ${delay}min` };
                                } else if (target.hasPersonalInjury) {
                                    target.remarks = { ja: '⚠ 人身事故', en: '⚠ Personal Injury' };
                                }
                            }
                        }
                    }
                }

                if (newData.length > 0) {
                    data = newData.sort((a, b) => new Date(a.departureTime) - new Date(b.departureTime));
                    logToScreen(`取得データ: ${data.length}件`);
                } else {
                    logToScreen('有効なデータなし。フォールバックを使用');
                    data = generateFallbackData();
                }
            } catch (error) {
                logToScreen(`データ取得エラー: ${error.message}`);
                data = generateFallbackData();
            }

            updatePersonalInjuryAlerts();
        }

        // 人身事故アラートを更新
        function updatePersonalInjuryAlerts() {
            if (!data || data.length === 0) {
                logToScreen('データが空です');
                return;
            }
            data.forEach((train, index) => {
                const row = document.getElementById(`row-${index}`);
                if (!row) return;
                row.classList.toggle('alert', train.hasPersonalInjury);
            });
        }

        // 丸印の状態を更新
        function updateStatusIndicators() {
            if (!data || data.length === 0) return;
            const now = new Date();
            data.forEach((train, index) => {
                const statusFlap = document.getElementById(`status-${index}`);
                if (!statusFlap) return;
                const departureTime = new Date(train.departureTime);
                const timeDiff = (departureTime - now) / 1000 / 60;

                statusFlap.classList.remove('grey', 'orange', 'blink');
                if (timeDiff > 30) {
                    statusFlap.classList.add('grey');
                } else if (timeDiff > 20) {
                    statusFlap.classList.add('orange');
                } else {
                    statusFlap.classList.add('orange', 'blink');
                }
            });
        }

        // フラップ更新
        function updateFlap(flap, newText) {
            if (!flap) return;
            const spans = flap.querySelectorAll('span');
            spans.forEach(span => flap.removeChild(span));

            const next = document.createElement('span');
            next.className = 'next';
            next.textContent = newText || '-';
            flap.appendChild(next);
            return { flap, next };
        }

        // 日本語/英語切り替え
        function updateSignage() {
            if (!data || data.length === 0) {
                logToScreen('データが空です');
                return;
            }
            const lang = isJapanese ? 'ja' : 'en';
            document.querySelector('.signage').setAttribute('lang', lang);

            const updates = [];
            updates.push(updateFlap(document.getElementById('title'), titleData[lang]));

            for (let index = 0; index < 6; index++) {
                const train = data[index] || {};
                updates.push(updateFlap(document.getElementById(`time-${index}`), train.time?.[lang] || '-'));
                updates.push(updateFlap(document.getElementById(`destination-${index}`), train.destination?.[lang] || '-'));
                updates.push(updateFlap(document.getElementById(`train-type-${index}`), train.trainType?.[lang] || '-'));
                updates.push(updateFlap(document.getElementById(`remarks-${index}`), train.remarks?.[lang] || '-'));
            }

            requestAnimationFrame(() => {
                updates.forEach(({ flap, next }) => {
                    if (flap && next) next.className = 'current';
                });
            });

            isJapanese = !isJapanese;
        }

        // 初期化と定期更新
        async function initialize() {
            await fetchTrainData();
            updateSignage();
            updateStatusIndicators();

            setInterval(updateSignage, 5000);
            setInterval(updateStatusIndicators, 1000);
            setInterval(fetchTrainData, 60000);
        }

        initialize();
    </script>
</body>
</html>