<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東京中野 8時間天気予報</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        table {
            width: 100%;
            max-width: 640px;
            border-collapse: collapse;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        td {
            width: 25%;
            height: 120px;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #ddd;
            padding: 0;
        }
        .weather-icon {
            width: 180px;
            height: 180px;
            margin: 0 auto;
        }
        .time {
            font-size: 2.8em;
            color: #333;
            margin-top: -8px;
            font-weight: bold;
        }
        @media (max-width: 1024px) {
            table {
                max-width: 560px;
            }
            td {
                height: 100px;
            }
            .weather-icon {
                width: 140px;
                height: 140px;
            }
            .time {
                font-size: 2.4em;
                margin-top: -6px;
            }
        }
    </style>
</head>
<body>
    <table>
        <tr>
            <td data-weather="01d">
                <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="晴れ" class="weather-icon">
                <div class="time" data-hour="0"></div>
            </td>
            <td data-weather="02d">
                <img src="https://openweathermap.org/img/wn/02d@2x.png" alt="曇り" class="weather-icon">
                <div class="time" data-hour="3"></div>
            </td>
            <td data-weather="03d">
                <img src="https://openweathermap.org/img/wn/03d@2x.png" alt="曇り" class="weather-icon">
                <div class="time" data-hour="6"></div>
            </td>
            <td data-weather="04d">
                <img src="https://openweathermap.org/img/wn/04d@2x.png" alt="厚い曇り" class="weather-icon">
                <div class="time" data-hour="9"></div>
            </td>
        </tr>
        <tr>
            <td data-weather="09d">
                <img src="https://openweathermap.org/img/wn/09d@2x.png" alt="小雨" class="weather-icon">
                <div class="time" data-hour="12"></div>
            </td>
            <td data-weather="10d">
                <img src="https://openweathermap.org/img/wn/10d@2x.png" alt="雨" class="weather-icon">
                <div class="time" data-hour="15"></div>
            </td>
            <td data-weather="01d">
                <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="晴れ" class="weather-icon">
                <div class="time" data-hour="18"></div>
            </td>
            <td data-weather="02d">
                <img src="https://openweathermap.org/img/wn/02d@2x.png" alt="曇り" class="weather-icon">
                <div class="time" data-hour="21"></div>
            </td>
        </tr>
    </table>

    <script>
        // 現在時刻を取得し、次の「3時間ごとの時刻」に揃える
        const now = new Date();
        const hours = now.getHours();
        const startHourOffset = Math.ceil(hours / 3) * 3;
        const startHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), startHourOffset, 0, 0);

        // 背景色を設定する関数
        function setBackgroundColor(cell, icon) {
            if (['01d', '01n'].includes(icon)) {
                cell.style.backgroundColor = '#f39c12'; // 晴れ：オレンジ
                cell.querySelector('.time').style.color = '#fff';
            } else if (['09d', '09n', '10d', '10n', '11d', '11n', '13d', '13n'].includes(icon)) {
                cell.style.backgroundColor = '#3498db'; // 雨/雪/雷：ブルー
                cell.querySelector('.time').style.color = '#fff';
            } else {
                cell.style.backgroundColor = '#fff'; // その他：白
                cell.querySelector('.time').style.color = '#333';
            }
        }

        // 各セルの時刻を初期化し、静的データの背景色を設定
        document.querySelectorAll('td').forEach(cell => {
            const offset = parseInt(cell.querySelector('.time').getAttribute('data-hour'));
            const time = new Date(startHour.getTime() + offset * 60 * 60 * 1000);
            const hours = time.getHours().toString().padStart(2, '0');
            cell.querySelector('.time').textContent = `${hours}:00`;
            // 初期背景色を設定
            const weatherCode = cell.getAttribute('data-weather');
            setBackgroundColor(cell, weatherCode);
        });

        // WMO天気コードをOpenWeatherMapアイコンにマッピング
        const weatherCodeMap = {
            0: '01d', // 快晴
            1: '02d', // 晴れ
            2: '03d', // 一部曇り
            3: '04d', // 曇り
            45: '50d', // 霧
            48: '50d', // 霧（氷点下）
            51: '09d', // 小雨
            53: '09d', // 中雨
            55: '10d', // 強い雨
            61: '10d', // 雨
            63: '10d', // 中程度の雨
            65: '10d', // 強い雨
            71: '13d', // 雪
            73: '13d', // 中程度の雪
            75: '13d', // 強い雪
            80: '09d', // にわか雨
            81: '10d', // 強いシャワー
            82: '10d', // 非常に強いシャワー
            95: '11d', // 雷雨
            96: '11d', // 雷雨（軽い雹）
            99: '11d'  // 雷雨（強い雹）
        };

        // Open-Meteo APIで天気データを取得
        const url = `https://api.open-meteo.com/v1/forecast?latitude=35.7076&longitude=139.6637&hourly=weathercode&timezone=Asia%2FTokyo&forecast_days=1`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const cells = document.querySelectorAll('td');
                const hourlyData = data.hourly;
                const times = hourlyData.time;
                const weatherCodes = hourlyData.weathercode;

                // 開始時刻以降の3時間ごとのデータを抽出
                const forecastList = [];
                const startTimeMs = startHour.getTime();
                for (let i = 0; i < times.length; i++) {
                    const forecastTime = new Date(times[i]);
                    const diffHours = (forecastTime - startTimeMs) / (1000 * 60 * 60);
                    if (diffHours >= 0 && diffHours % 3 === 0 && forecastList.length < 8) {
                        forecastList.push({
                            time: forecastTime,
                            weathercode: weatherCodes[i]
                        });
                    }
                }

                cells.forEach((cell, index) => {
                    if (forecastList[index]) {
                        const item = forecastList[index];
                        const icon = weatherCodeMap[item.weathercode] || '01d'; // デフォルトは晴れ
                        console.log(`セル${index}: WMOコード=${item.weathercode}, アイコン=${icon}`); // デバッグ用
                        const time = item.time;
                        const hours = time.getHours().toString().padStart(2, '0');
                        cell.querySelector('img').src = `https://openweathermap.org/img/wn/${icon}@2x.png`;
                        cell.querySelector('img').alt = item.weathercode in weatherCodeMap ? '天気' : '不明';
                        cell.querySelector('.time').textContent = `${hours}:00`;
                        cell.setAttribute('data-weather', icon);
                        setBackgroundColor(cell, icon);
                    }
                });
            })
            .catch(error => {
                console.error('天気データ取得エラー:', error);
                // エラー時は静的データの背景色を再適用
                document.querySelectorAll('td').forEach(cell => {
                    const weatherCode = cell.getAttribute('data-weather');
                    setBackgroundColor(cell, weatherCode);
                });
            });
    </script>
</body>
</html>